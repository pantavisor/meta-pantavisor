# Copyright (c) 2025-2026 Pantacor Ltd.
# SPDX-License-Identifier: MIT

#@TYPE: Machine
#@NAME: x86-64 EFI (QEMU testable)
#@DESCRIPTION: x86-64 machine with linux-yocto kernel, UEFI boot via
#              pv-efi-boot A/B partition layout. Testable with QEMU + OVMF.

DEFAULTTUNE = "core2-64"
require conf/machine/include/x86/tune-corei7.inc

PREFERRED_PROVIDER_virtual/kernel = "linux-yocto"
KMACHINE:x64-efi = "common-pc-64"

MACHINE_FEATURES = "efi pcbios serial"

KERNEL_IMAGETYPE = "bzImage"
KERNEL_EXTRA_FEATURES ?= "cfg/efi.scc cfg/fs/vfat.scc"

# Keep kernel and initramfs separate â€” UKI assembly combines them.
# Use machine override so distro conf cannot re-enable bundling.
INITRAMFS_IMAGE_BUNDLE:x64-efi = "0"

SERIAL_CONSOLES = "115200;ttyS0"

IMAGE_FSTYPES = "wic wic.bmap"
WKS_FILE = "pantavisor-efi.wks"

# EFI boot components
EXTRA_IMAGEDEPENDS += "pv-efi-boot pv-uki ovmf"

# EFI A/B boot image for pantavisor updates
PVBSP_EFIAB_BOOTIMG = "efi-boot-image-${MACHINE}.vfat"

# QEMU settings for testing with OVMF
QB_SYSTEM_NAME = "qemu-system-x86_64"
QB_MACHINE = "-machine q35"
QB_CPU = "-cpu IvyBridge"
QB_MEM = "-m 1024"
QB_SMP = "-smp 4"
QB_DRIVE_TYPE = "/dev/sda"
QB_KERNEL_CMDLINE_APPEND = "console=ttyS0,115200"
QB_OPT_APPEND = "-nographic -serial mon:stdio"
