#!/bin/sh

set -e

targetdir=$1

yocto_branch=$(jq -r .yocto_branch .github/machines.json)
machines=$(jq -r .machines[] .github/machines.json)

echo "Processing machines:

$machines"

rm -f .github/configs/release/*-$yocto_branch.yaml*

for cc in $machines; do
	echo CC: $cc
	m=`echo $cc | sed 's/.*machines.//;s/.yaml:.*//'`
	KAS_WORK_DIR=. kas dump --update --resolve-refs "kas/sourcedir.yaml:$cc" > .github/configs/release/$m-$yocto_branch.yaml
	echo "new config for machine: $m"
done

echo DIFF:
git diff HEAD .github/
